CREATE VIEW `wb4_mailinglistaddresses` AS (select distinct `u`.`email` AS `address`,`u`.`username` AS `username`,`m`.`address` AS `mailinglist`,`m`.`event_id` AS `event_id`,`e`.`reference` AS `event_reference`,`u`.`realname` AS `realname` from ((((`wb4_users` `u` join `wb4_crews_users` `uc`) join `wb4_mailinglistrules` `mr`) join `wb4_mailinglists` `m`) join `wb4_events` `e`) where ((`u`.`id` = `uc`.`user_id`) and (`mr`.`crew_id` = `uc`.`crew_id`) and (`mr`.`action` = 'add') and (`uc`.`leader` >= `mr`.`leader`) and (`m`.`id` = `mr`.`mailinglist_id`) and (`e`.`id` = `m`.`event_id`) and (((`m`.`optional` = 1) and ((select `ui`.`subscribe` from `wb4_user_mailprefs` `ui` where ((`ui`.`user_id` = `u`.`id`) and (`ui`.`event_id` = `e`.`id`) and (`ui`.`mailinglist_id` = `m`.`id`) and (`ui`.`subscribe` = 1)) limit 1) = 1)) or (`m`.`optional` <> 1)))) union (select distinct `u`.`email` AS `address`,`u`.`username` AS `username`,`m`.`address` AS `mailinglist`,`m`.`event_id` AS `event_id`,`e`.`reference` AS `event_reference`,`u`.`realname` AS `realname` from ((((`wb4_users` `u` join `wb4_crews_users` `uc`) join `wb4_mailinglistrule_teams` `mr`) join `wb4_mailinglists` `m`) join `wb4_events` `e`) where ((`u`.`id` = `uc`.`user_id`) and (`mr`.`team_id` = `uc`.`team_id`) and (`mr`.`action` = 'add') and (`m`.`id` = `mr`.`mailinglist_id`) and (`e`.`id` = `m`.`event_id`) and (((`m`.`optional` = 1) and ((select `ui`.`subscribe` from `wb4_user_mailprefs` `ui` where ((`ui`.`user_id` = `u`.`id`) and (`ui`.`event_id` = `e`.`id`) and (`ui`.`mailinglist_id` = `m`.`id`) and (`ui`.`subscribe` = 1)) limit 1) = 1)) or (`m`.`optional` <> 1)))) union (select distinct `u`.`email` AS `address`,`u`.`username` AS `username`,`m`.`address` AS `mailinglist`,`m`.`event_id` AS `event_id`,`e`.`reference` AS `event_reference`,`u`.`realname` AS `realname` from ((((`wb4_users` `u` join `wb4_crews_users` `uc`) join `wb4_mailinglistrule_users` `mr`) join `wb4_mailinglists` `m`) join `wb4_events` `e`) where ((`u`.`id` = `uc`.`user_id`) and (`mr`.`user_id` = `uc`.`user_id`) and (`mr`.`action` = 'add') and (`m`.`id` = `mr`.`mailinglist_id`) and (`e`.`id` = `m`.`event_id`) and (((`m`.`optional` = 1) and ((select `ui`.`subscribe` from `wb4_user_mailprefs` `ui` where ((`ui`.`user_id` = `u`.`id`) and (`ui`.`event_id` = `e`.`id`) and (`ui`.`mailinglist_id` = `m`.`id`) and (`ui`.`subscribe` = 1)) limit 1) = 1)) or (`m`.`optional` <> 1))))
